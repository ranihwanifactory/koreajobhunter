import React, { useState, useEffect } from 'react';
import { Bell, BellOff, Check, X } from 'lucide-react';

export default function PushNotificationApp() {
  const [permission, setPermission] = useState('default');
  const [isSupported, setIsSupported] = useState(false);
  const [message, setMessage] = useState('');

  useEffect(() => {
    // Service Worker 및 알림 지원 확인
    if ('serviceWorker' in navigator && 'Notification' in window) {
      setIsSupported(true);
      setPermission(Notification.permission);
    }
  }, []);

  const requestPermission = async () => {
    try {
      const result = await Notification.requestPermission();
      setPermission(result);
      
      if (result === 'granted') {
        setMessage('알림 권한이 허용되었습니다!');
        // Service Worker 등록
        registerServiceWorker();
      } else {
        setMessage('알림 권한이 거부되었습니다.');
      }
    } catch (error) {
      setMessage('오류: ' + error.message);
    }
  };

  const registerServiceWorker = async () => {
    try {
      const registration = await navigator.serviceWorker.register('/sw.js');
      setMessage('Service Worker가 등록되었습니다!');
      console.log('SW registered:', registration);
    } catch (error) {
      setMessage('Service Worker 등록 실패: ' + error.message);
      console.error('SW registration failed:', error);
    }
  };

  const sendTestNotification = () => {
    if (permission === 'granted') {
      new Notification('테스트 알림', {
        body: '푸시 알림이 정상적으로 작동합니다!',
        icon: '/icon.png',
        badge: '/badge.png',
        tag: 'test-notification',
        requireInteraction: false
      });
      setMessage('테스트 알림을 전송했습니다.');
    } else {
      setMessage('먼저 알림 권한을 허용해주세요.');
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-8">
      <div className="max-w-2xl mx-auto">
        <div className="bg-white rounded-2xl shadow-xl p-8">
          <div className="flex items-center gap-4 mb-6">
            <Bell className="w-10 h-10 text-indigo-600" />
            <h1 className="text-3xl font-bold text-gray-800">푸시 알림 앱</h1>
          </div>

          {/* 환경 경고 */}
          <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
            <div className="flex items-start">
              <div className="flex-shrink-0">
                <svg className="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                  <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                </svg>
              </div>
              <div className="ml-3">
                <p className="text-sm text-yellow-700">
                  <strong>Claude Artifacts 환경에서는 Service Worker가 작동하지 않습니다.</strong>
                  <br />이 코드를 복사하여 자체 서버에서 실행하세요.
                </p>
              </div>
            </div>
          </div>

          {/* 지원 여부 */}
          <div className="mb-6 p-4 bg-gray-50 rounded-lg">
            <h2 className="font-semibold text-gray-700 mb-2">환경 확인</h2>
            <div className="space-y-2">
              <div className="flex items-center gap-2">
                {isSupported ? (
                  <Check className="w-5 h-5 text-green-500" />
                ) : (
                  <X className="w-5 h-5 text-red-500" />
                )}
                <span className="text-sm">
                  Service Worker 지원: {isSupported ? '예' : '아니오'}
                </span>
              </div>
              <div className="flex items-center gap-2">
                {permission === 'granted' ? (
                  <Check className="w-5 h-5 text-green-500" />
                ) : permission === 'denied' ? (
                  <X className="w-5 h-5 text-red-500" />
                ) : (
                  <BellOff className="w-5 h-5 text-gray-400" />
                )}
                <span className="text-sm">
                  알림 권한 상태: {
                    permission === 'granted' ? '허용됨' :
                    permission === 'denied' ? '거부됨' : '미설정'
                  }
                </span>
              </div>
            </div>
          </div>

          {/* 버튼 영역 */}
          <div className="space-y-4 mb-6">
            <button
              onClick={requestPermission}
              disabled={permission === 'granted'}
              className="w-full bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-300 text-white font-semibold py-3 px-6 rounded-lg transition-colors"
            >
              {permission === 'granted' ? '알림 권한 허용됨' : '알림 권한 요청'}
            </button>

            <button
              onClick={sendTestNotification}
              disabled={permission !== 'granted'}
              className="w-full bg-green-600 hover:bg-green-700 disabled:bg-gray-300 text-white font-semibold py-3 px-6 rounded-lg transition-colors"
            >
              테스트 알림 보내기
            </button>
          </div>

          {/* 메시지 표시 */}
          {message && (
            <div className="p-4 bg-blue-50 border-l-4 border-blue-400 rounded">
              <p className="text-sm text-blue-700">{message}</p>
            </div>
          )}

          {/* 설치 가이드 */}
          <div className="mt-8 p-6 bg-gray-50 rounded-lg">
            <h2 className="font-bold text-gray-800 mb-4">자체 호스팅 가이드</h2>
            <ol className="space-y-3 text-sm text-gray-700">
              <li className="flex gap-2">
                <span className="font-semibold min-w-[24px]">1.</span>
                <span>이 코드를 HTML 파일로 저장하세요.</span>
              </li>
              <li className="flex gap-2">
                <span className="font-semibold min-w-[24px]">2.</span>
                <span>프로젝트 루트에 <code className="bg-gray-200 px-2 py-1 rounded">sw.js</code> 파일을 생성하세요 (아래 코드 참조).</span>
              </li>
              <li className="flex gap-2">
                <span className="font-semibold min-w-[24px]">3.</span>
                <span>HTTPS로 제공되는 서버에 배포하세요 (localhost는 HTTP 가능).</span>
              </li>
              <li className="flex gap-2">
                <span className="font-semibold min-w-[24px]">4.</span>
                <span>Vercel, Netlify, GitHub Pages 등을 사용할 수 있습니다.</span>
              </li>
            </ol>
          </div>
        </div>
      </div>
    </div>
  );
}
